From f96bddbaf8ebc4f28e75fab2f7b3568b62d31d92 Mon Sep 17 00:00:00 2001
From: dpath2o <dpath2o@mac.com>
Date: Mon, 27 Oct 2025 04:08:11 +1100
Subject: [PATCH 18/34] CDP testing

---
 cicecore/cicedyn/dynamics/ice_dyn_evp.F90    | 55 ++++++++++++++++++--
 cicecore/cicedyn/dynamics/ice_dyn_shared.F90 |  2 -
 cicecore/cicedyn/infrastructure/ice_grid.F90 | 24 +++++++--
 3 files changed, 71 insertions(+), 10 deletions(-)

diff --git a/cicecore/cicedyn/dynamics/ice_dyn_evp.F90 b/cicecore/cicedyn/dynamics/ice_dyn_evp.F90
index 687eb0a..97145ad 100644
--- a/cicecore/cicedyn/dynamics/ice_dyn_evp.F90
+++ b/cicecore/cicedyn/dynamics/ice_dyn_evp.F90
@@ -53,7 +53,6 @@ module ice_dyn_evp
       use ice_exit, only: abort_ice
       use icepack_intfc, only: icepack_warnings_flush, icepack_warnings_aborted
       use icepack_intfc, only: icepack_ice_strength, icepack_query_parameters
-      use ice_grid, only: F2E, F2N, build_F2_form_factors_cgrid
 
       implicit none
       private
@@ -130,7 +129,8 @@ subroutine init_evp
       use ice_blocks, only: get_block, nx_block, ny_block, nghost, block
       use ice_domain_size, only: max_blocks
       use ice_domain, only: nblocks, blocks_ice
-      use ice_grid, only: grid_ice, dyT, dxT, uarear, tmask, G_HTE, G_HTN, dxN, dyE
+      use ice_grid, only: grid_ice, dyT, dxT, uarear, tmask, G_HTE, G_HTN, dxN, dyE, &
+         build_F2_form_factors_cgrid, F2E, F2N
       use ice_calendar, only: dt_dyn
       use ice_dyn_shared, only: init_dyn_shared, evp_algorithm, &
          iceEmask, iceNmask, coastal_drag, create_form_factors
@@ -165,7 +165,10 @@ subroutine init_evp
          !       enddo
          !    enddo
          ! enddo
-         call build_F2_form_factors_cgrid()
+         if (.not. allocated(F2E)) allocate(F2E(nx_block,ny_block,max_blocks))
+         if (.not. allocated(F2N)) allocate(F2N(nx_block,ny_block,max_blocks))
+         call build_F2_form_factors_cgrid(F2E, F2N, test_case=.true.)
+         !call build_F2_form_factors_cgrid()
       endif
 
       if (evp_algorithm == "shared_mem_1d" ) then
@@ -301,7 +304,8 @@ subroutine evp (dt)
       use ice_grid, only: tmask, umask, umaskCD, nmask, emask, uvm, epm, npm, &
           dxE, dxN, dxT, dxU, dyE, dyN, dyT, dyU, &
           tarear, uarear, earear, narear, grid_average_X2Y, uarea, &
-          grid_ice, grid_atm_dynu, grid_atm_dynv, grid_ocn_dynu, grid_ocn_dynv
+          grid_ice, grid_atm_dynu, grid_atm_dynv, grid_ocn_dynu, grid_ocn_dynv, &
+          F2E, F2N
       use ice_state, only: aice, aiU, vice, vsno, uvel, vvel, uvelN, vvelN, &
           uvelE, vvelE, divu, shear, vort, &
           aice_init, aice0, aicen, vicen, strength
@@ -815,6 +819,48 @@ subroutine evp (dt)
       !-----------------------------------------------------------------
       if (coastal_drag) then
          if (grid_ice == "C") then
+            ! --- Diagnostics at end of subcycling ---------------------------------
+            nE = count(epm > c0)
+            nN = count(npm > c0)
+            nU = count(uvm > c0)
+            ! E-faces (AT CDP CALL stepu_C)
+            write(nu_diag,9000) 'AT CDP CALL stepu_C  F2E  min/max/avg =', &
+               minval(F2E , mask=epm>c0),  maxval(F2E , mask=epm>c0),  &
+               sum(F2E , mask=epm>c0)/real(max(1,nE),dbl_kind)
+            write(nu_diag,9000) 'AT CDP CALL stepu_C  KuE  min/max/avg =', &
+               minval(KuE , mask=epm>c0),  maxval(KuE , mask=epm>c0),  &
+               sum(KuE , mask=epm>c0)/real(max(1,nE),dbl_kind)
+            write(nu_diag,9000) 'AT CDP CALL stepu_C  KuxE min/max/avg =', &
+               minval(KuxE, mask=epm>c0),  maxval(KuxE, mask=epm>c0),  &
+               sum(KuxE, mask=epm>c0)/real(max(1,nE),dbl_kind)
+            write(nu_diag,9000) 'AT CDP CALL stepu_C  KuyE min/max/avg =', &
+               minval(KuyE, mask=epm>c0),  maxval(KuyE, mask=epm>c0),  &
+               sum(KuyE, mask=epm>c0)/real(max(1,nE),dbl_kind)
+            ! N-faces (AT CDP CALL stepv_C)
+            write(nu_diag,9000) 'AT CDP CALL stepv_C  F2N  min/max/avg =', &
+               minval(F2N , mask=npm>c0),  maxval(F2N , mask=npm>c0),  &
+               sum(F2N , mask=npm>c0)/real(max(1,nN),dbl_kind)
+            write(nu_diag,9000) 'AT CDP CALL stepv_C  KuN  min/max/avg =', &
+               minval(KuN , mask=npm>c0),  maxval(KuN , mask=npm>c0),  &
+               sum(KuN , mask=npm>c0)/real(max(1,nN),dbl_kind)
+            write(nu_diag,9000) 'AT CDP CALL stepv_C  KuxN min/max/avg =', &
+               minval(KuxN, mask=npm>c0),  maxval(KuxN, mask=npm>c0),  &
+               sum(KuxN, mask=npm>c0)/real(max(1,nN),dbl_kind)
+            write(nu_diag,9000) 'AT CDP CALL stepv_C  KuyN min/max/avg =', &
+               minval(KuyN, mask=npm>c0),  maxval(KuyN, mask=npm>c0),  &
+               sum(KuyN, mask=npm>c0)/real(max(1,nN),dbl_kind)
+            ! U-corners (AT CDP CALL stressC_U / U-averaging)
+            write(nu_diag,9000) 'AT CDP CALL stressC_U KuU  min/max/avg =', &
+               minval(KuU , mask=uvm>c0),  maxval(KuU , mask=uvm>c0),  &
+               sum(KuU , mask=uvm>c0)/real(max(1,nU),dbl_kind)
+            write(nu_diag,9000) 'AT CDP CALL stressC_U KuxU min/max/avg =', &
+               minval(KuxU, mask=uvm>c0),  maxval(KuxU, mask=uvm>c0),  &
+               sum(KuxU, mask=uvm>c0)/real(max(1,nU),dbl_kind)
+            write(nu_diag,9000) 'AT CDP CALL stressC_U KuyU min/max/avg =', &
+               minval(KuyU, mask=uvm>c0),  maxval(KuyU, mask=uvm>c0),  &
+               sum(KuyU, mask=uvm>c0)/real(max(1,nU),dbl_kind)
+            9000 format(a,3(1pe16.8,1x))
+            ! ----------------------------------------------------------------------
             !$OMP PARALLEL DO PRIVATE(iblk) SCHEDULE(runtime)
             do iblk = 1, nblocks
                call coastal_drag_stress_factor(nx_block          , ny_block,         &
@@ -1083,7 +1129,6 @@ subroutine evp (dt)
                   minval(KuyU, mask=uvm>c0),  maxval(KuyU, mask=uvm>c0),  &
                   sum(KuyU, mask=uvm>c0)/real(max(1,nU),dbl_kind)
             end if
-            9000 format(a,3(1pe16.8,1x))
             ! ----------------------------------------------------------------------
 
             ! calls ice_haloUpdate, controls bundles and masks
diff --git a/cicecore/cicedyn/dynamics/ice_dyn_shared.F90 b/cicecore/cicedyn/dynamics/ice_dyn_shared.F90
index 4888305..928dab3 100644
--- a/cicecore/cicedyn/dynamics/ice_dyn_shared.F90
+++ b/cicecore/cicedyn/dynamics/ice_dyn_shared.F90
@@ -158,8 +158,6 @@ module ice_dyn_shared
          Cs, &  ! static function coefficient; Liu et al. (2022) eq.13; 1.0*10^{âˆ’4} m/s^2
          u0     ! residual velocity for coastal drag stress (and seabed stress) (m/s)
 
-
-
       interface strain_rates_T
          module procedure strain_rates_Tdt
          module procedure strain_rates_Tdtsd
diff --git a/cicecore/cicedyn/infrastructure/ice_grid.F90 b/cicecore/cicedyn/infrastructure/ice_grid.F90
index 30b49a6..e392d0d 100644
--- a/cicecore/cicedyn/infrastructure/ice_grid.F90
+++ b/cicecore/cicedyn/infrastructure/ice_grid.F90
@@ -2608,7 +2608,9 @@ subroutine rectgrid_scale_dxdy
 
       end subroutine rectgrid_scale_dxdy
 
-subroutine build_F2_form_factors_cgrid(coast_file, coast_var, F2_value, test_case)
+
+!=======================================================================
+subroutine build_F2_form_factors_cgrid(F2E, F2N, coast_file, coast_var, F2_value, test_case)
    use ice_kinds_mod
    use ice_blocks       , only: get_block, nx_block, ny_block, block
    use ice_domain       , only: nblocks, blocks_ice
@@ -2624,6 +2626,10 @@ subroutine build_F2_form_factors_cgrid(coast_file, coast_var, F2_value, test_cas
    real   (kind=dbl_kind),   intent(in), optional :: F2_value    ! default 0.25
    logical(kind=log_kind),   intent(in), optional :: test_case   ! if true and no coast_file, treat perimeter as coastline
 
+   ! ---- REQUIRED outputs (already allocated by caller) ----
+   real(kind=dbl_kind), intent(inout) :: F2E(nx_block,ny_block,max_blocks)
+   real(kind=dbl_kind), intent(inout) :: F2N(nx_block,ny_block,max_blocks)
+
    ! ----- locals -----
    type(block)               :: this_block
    integer(kind=int_kind)    :: iblk, i, j, ilo, ihi, jlo, jhi
@@ -2647,8 +2653,8 @@ subroutine build_F2_form_factors_cgrid(coast_file, coast_var, F2_value, test_cas
    want_perimeter = .false.; if (present(test_case)) want_perimeter = test_case
 
    ! ----- allocate/clear outputs -----
-   if (.not. allocated(F2E)) allocate(F2E(nx_block,ny_block,max_blocks))
-   if (.not. allocated(F2N)) allocate(F2N(nx_block,ny_block,max_blocks))
+   ! if (.not. allocated(F2E)) allocate(F2E(nx_block,ny_block,max_blocks))
+   ! if (.not. allocated(F2N)) allocate(F2N(nx_block,ny_block,max_blocks))
    F2E = 0.0d0
    F2N = 0.0d0
 
@@ -2767,6 +2773,18 @@ subroutine build_F2_form_factors_cgrid(coast_file, coast_var, F2_value, test_cas
       if (allocated(coastT)) deallocate(coastT)
    end if
 
+   cntE_act = 0
+   cntN_act = 0
+   !$OMP PARALLEL DO PRIVATE(iblk,this_block,ilo,ihi,jlo,jhi) REDUCTION(+:cntE_act,cntN_act)
+   do iblk = 1, nblocks
+      this_block = get_block(blocks_ice(iblk), iblk)
+      ilo = this_block%ilo;  ihi = this_block%ihi
+      jlo = this_block%jlo;  jhi = this_block%jhi
+      cntE_act = cntE_act + (ihi-ilo)  * (jhi-jlo+1)   ! E faces per block
+      cntN_act = cntN_act + (ihi-ilo+1)* (jhi-jlo)     ! N faces per block
+   end do
+   !$OMP END PARALLEL DO
+
    ! ----- diagnostics -----
    write(nu_diag,'(a,l1,a,i10,a,i10)') 'build_F2: use_coast=', use_coast,  &
       '  E faces active=', cntE_act, '  E coast-adj=', cntE_adj
-- 
2.43.7

