From 92aa07377241b0125e602a4bcb330ce839144463 Mon Sep 17 00:00:00 2001
From: dpath2o <dpath2o@mac.com>
Date: Sat, 25 Oct 2025 07:58:50 +1100
Subject: [PATCH 14/34] another attempt to get CDP working: slight modification
 to subroutine alloc_flux in ice_flux.F90

---
 cicecore/cicedyn/dynamics/ice_dyn_evp.F90    | 67 --------------------
 cicecore/cicedyn/dynamics/ice_dyn_shared.F90 | 56 ++++++++--------
 cicecore/cicedyn/general/ice_flux.F90        | 16 +++--
 3 files changed, 37 insertions(+), 102 deletions(-)

diff --git a/cicecore/cicedyn/dynamics/ice_dyn_evp.F90 b/cicecore/cicedyn/dynamics/ice_dyn_evp.F90
index 6177e7a..d2cb0db 100644
--- a/cicecore/cicedyn/dynamics/ice_dyn_evp.F90
+++ b/cicecore/cicedyn/dynamics/ice_dyn_evp.F90
@@ -1142,36 +1142,6 @@ subroutine evp (dt)
                               uvelN     (:,:,iblk), vvelN     (:,:,iblk), &
                               TbN       (:,:,iblk),                       &
                               KuxN      (:,:,iblk), KuN       (:,:,iblk))
-
-               if (ksub == ndte) then
-                  do j = 1, ny_block
-                     do i = 1, nx_block-1
-                        if (i >= 2 .and. j >= 2 .and. i <= nx_block-1 .and. j <= ny_block-1) then
-                           if ( (epm(i  ,j  , iblk) == c0) .or. (epm(i  ,j-1, iblk) == c0) .or. &
-                                (npm(i  ,j  , iblk) == c0) .or. (npm(i-1,j  , iblk) == c0) ) then
-                              !$OMP CRITICAL (IO_DIAG)
-                              write(nu_diag,'(a,3i6,1p,2e16.8)') 'E-coast AFTER step (blk,i,j): uE, vE =', &
-                              iblk, i, j, uvelE(i,j,iblk), vvelE(i,j,iblk)
-                              !$OMP END CRITICAL (IO_DIAG)
-                           end if
-                        end if
-                     end do
-                  end do
-                  do j = 1, ny_block-1
-                     do i = 1, nx_block
-                        if (i >= 2 .and. j >= 2 .and. i <= nx_block-1 .and. j <= ny_block-1) then
-                           if ( (epm(i  ,j  , iblk) == c0) .or. (epm(i  ,j-1, iblk) == c0) .or. &
-                                (npm(i  ,j  , iblk) == c0) .or. (npm(i-1,j  , iblk) == c0) ) then
-                              !$OMP CRITICAL (IO_DIAG)
-                              write(nu_diag,'(a,3i6,1p,2e16.8)') 'N-coast AFTER step (blk,i,j): vN, uN =', &
-                              iblk, i, j, vvelN(i,j,iblk), uvelN(i,j,iblk)
-                              !$OMP END CRITICAL (IO_DIAG)
-                           end if
-                        end if
-                     end do
-                  end do
-                  call flush(nu_diag)
-               end if
             enddo
             !$OMP END PARALLEL DO
 
@@ -1188,43 +1158,6 @@ subroutine evp (dt)
             uvelN(:,:,:) = uvelN(:,:,:)*npm(:,:,:)
             vvelE(:,:,:) = vvelE(:,:,:)*epm(:,:,:)
 
-            ! -- DIAG 2: after E<->N reconstruction (last subcycle only) --
-            if (ksub == ndte) then
-               !$OMP PARALLEL DO PRIVATE(iblk,i,j)
-               do iblk = 1, nblocks
-                  ! E faces: normal=uvelE, tangential=vvelE
-                  do j = 1, ny_block
-                     do i = 1, nx_block-1
-                        if (i >= 2 .and. j >= 2 .and. i <= nx_block-1 .and. j <= ny_block-1) then
-                           if ( (epm(i  ,j  , iblk) == c0) .or. (epm(i  ,j-1, iblk) == c0) .or. &
-                                (npm(i  ,j  , iblk) == c0) .or. (npm(i-1,j  , iblk) == c0) ) then
-                              !$OMP CRITICAL (IO_DIAG)
-                              write(nu_diag,'(a,3i6,1p,2e16.8)') 'E-coast AFTER recon (blk,i,j): uE, vE =', &
-                              iblk, i, j, uvelE(i,j,iblk), vvelE(i,j,iblk)
-                              !$OMP END CRITICAL (IO_DIAG)
-                           end if
-                        end if
-                     end do
-                  end do
-                  ! N faces: normal=vvelN, tangential=uvelN
-                  do j = 1, ny_block-1
-                     do i = 1, nx_block
-                        if (i >= 2 .and. j >= 2 .and. i <= nx_block-1 .and. j <= ny_block-1) then
-                           if ( (epm(i  ,j  , iblk) == c0) .or. (epm(i  ,j-1, iblk) == c0) .or. &
-                                (npm(i  ,j  , iblk) == c0) .or. (npm(i-1,j  , iblk) == c0) ) then
-                              !$OMP CRITICAL (IO_DIAG)
-                              write(nu_diag,'(a,3i6,1p,2e16.8)') 'N-coast AFTER recon (blk,i,j): vN, uN =', &
-                              iblk, i, j, vvelN(i,j,iblk), uvelN(i,j,iblk)
-                              !$OMP END CRITICAL (IO_DIAG)
-                           end if
-                        end if
-                     end do
-                  end do
-               end do
-               !$OMP END PARALLEL DO
-               call flush(nu_diag)
-            end if
-
             ! calls ice_haloUpdate, controls bundles and masks
             call dyn_haloUpdate (halo_info,       halo_info_mask,    &
                                  field_loc_Nface, field_type_vector, &
diff --git a/cicecore/cicedyn/dynamics/ice_dyn_shared.F90 b/cicecore/cicedyn/dynamics/ice_dyn_shared.F90
index 70fadf5..4888305 100644
--- a/cicecore/cicedyn/dynamics/ice_dyn_shared.F90
+++ b/cicecore/cicedyn/dynamics/ice_dyn_shared.F90
@@ -2670,20 +2670,20 @@ subroutine strain_rates_U_no_slip (nx_block,   ny_block,  &
 
          ! Delta (in the denominator of zeta, eta)
          DeltaU(i,j)   = sqrt(divergU(i,j)**2 + e_factor*(tensionU(i,j)**2 + shearU(i,j)**2))
-         ! ---------- Diagnostics: print coastal U only (last subcycle) ----------
-         if (ksub == ndte) then
-            ! U(i,j) is the NE corner of T(i,j). It is "coastal" if any of the
-            ! four faces meeting at the corner are land (mask==0).
-            ! Adjacent faces around U(i,j): E(i,j), E(i,j-1), N(i,j), N(i-1,j)
-            if (i >= 2 .and. j >= 2 .and. i <= nx_block-1 .and. j <= ny_block-1) then
-               if ( (epm(i  ,j  ) == c0) .or. (epm(i  ,j-1) == c0) .or. &
-                    (npm(i  ,j  ) == c0) .or. (npm(i-1,j  ) == c0) ) then
-                  !$OMP CRITICAL (IO_DIAG)
-                  write(nu_diag,'(a,2i6,1p,e16.8)') 'no-slip U-coast shearU  (i,j)=', i, j, shearU(i,j)
-                  !$OMP END CRITICAL (IO_DIAG)
-               end if
-            end if
-         end if
+         ! ! ---------- Diagnostics: print coastal U only (last subcycle) ----------
+         ! if (ksub == ndte) then
+         !    ! U(i,j) is the NE corner of T(i,j). It is "coastal" if any of the
+         !    ! four faces meeting at the corner are land (mask==0).
+         !    ! Adjacent faces around U(i,j): E(i,j), E(i,j-1), N(i,j), N(i-1,j)
+         !    if (i >= 2 .and. j >= 2 .and. i <= nx_block-1 .and. j <= ny_block-1) then
+         !       if ( (epm(i  ,j  ) == c0) .or. (epm(i  ,j-1) == c0) .or. &
+         !            (npm(i  ,j  ) == c0) .or. (npm(i-1,j  ) == c0) ) then
+         !          !$OMP CRITICAL (IO_DIAG)
+         !          write(nu_diag,'(a,2i6,1p,e16.8)') 'no-slip U-coast shearU  (i,j)=', i, j, shearU(i,j)
+         !          !$OMP END CRITICAL (IO_DIAG)
+         !       end if
+         !    end if
+         ! end if
       enddo
       if (ksub == ndte) call flush(nu_diag)
       end subroutine strain_rates_U_no_slip
@@ -2767,20 +2767,20 @@ subroutine strain_rates_U_free_slip(nx_block, ny_block,  &
             ! shear = 2 e_12
             shearU(i,j) =  dxU(i,j) * (uEijp1 - uEij) - uvelU(i,j) * (dxE(i  ,j+1) - dxE(i,j))  &
                         +  dyU(i,j) * (vNip1j - vNij) - vvelU(i,j) * (dyN(i+1,j  ) - dyN(i,j))
-         ! ---------- Diagnostics: print coastal U only (last subcycle) ----------
-         if (ksub == ndte) then
-            ! U(i,j) is the NE corner of T(i,j). It is "coastal" if any of the
-            ! four faces meeting at the corner are land (mask==0).
-            ! Adjacent faces around U(i,j): E(i,j), E(i,j-1), N(i,j), N(i-1,j)
-            if (i >= 2 .and. j >= 2 .and. i <= nx_block-1 .and. j <= ny_block-1) then
-               if ( (epm(i  ,j  ) == c0) .or. (epm(i  ,j-1) == c0) .or. &
-                    (npm(i  ,j  ) == c0) .or. (npm(i-1,j  ) == c0) ) then
-                  !$OMP CRITICAL (IO_DIAG)
-                  write(nu_diag,'(a,2i6,1p,e16.8)') 'free-slip U-coast shearU  (i,j)=', i, j, shearU(i,j)
-                  !$OMP END CRITICAL (IO_DIAG)
-               end if
-            end if
-         end if
+         ! ! ---------- Diagnostics: print coastal U only (last subcycle) ----------
+         ! if (ksub == ndte) then
+         !    ! U(i,j) is the NE corner of T(i,j). It is "coastal" if any of the
+         !    ! four faces meeting at the corner are land (mask==0).
+         !    ! Adjacent faces around U(i,j): E(i,j), E(i,j-1), N(i,j), N(i-1,j)
+         !    if (i >= 2 .and. j >= 2 .and. i <= nx_block-1 .and. j <= ny_block-1) then
+         !       if ( (epm(i  ,j  ) == c0) .or. (epm(i  ,j-1) == c0) .or. &
+         !            (npm(i  ,j  ) == c0) .or. (npm(i-1,j  ) == c0) ) then
+         !          !$OMP CRITICAL (IO_DIAG)
+         !          write(nu_diag,'(a,2i6,1p,e16.8)') 'free-slip U-coast shearU  (i,j)=', i, j, shearU(i,j)
+         !          !$OMP END CRITICAL (IO_DIAG)
+         !       end if
+         !    end if
+         ! end if
       enddo
       if (ksub == ndte) call flush(nu_diag)
       end subroutine strain_rates_U_free_slip
diff --git a/cicecore/cicedyn/general/ice_flux.F90 b/cicecore/cicedyn/general/ice_flux.F90
index c0b07e0..5ad4e96 100644
--- a/cicecore/cicedyn/general/ice_flux.F90
+++ b/cicecore/cicedyn/general/ice_flux.F90
@@ -666,13 +666,15 @@ subroutine alloc_flux
          stresspU   (nx_block,ny_block,max_blocks), & ! sigma11+sigma22
          stressmU   (nx_block,ny_block,max_blocks), & ! sigma11-sigma22
          stress12U  (nx_block,ny_block,max_blocks), & ! sigma12
-         KuU        (nx_block,ny_block,max_blocks), & ! coastal drag stress factor at U points (landfast ice)
-         KuN        (nx_block,ny_block,max_blocks), & ! coastal drag stress factor at N points (landfast ice)
-         KuxN       (nx_block,ny_block,max_blocks), & ! coastal drag stress (x) at N points (N/m^2)
-         KuyN       (nx_block,ny_block,max_blocks), & ! coastal drag stress (y) at N points (N/m^2)
-         KuE        (nx_block,ny_block,max_blocks), & ! coastal drag stress factor at E points (landfast ice)
-         KuxE       (nx_block,ny_block,max_blocks), & ! coastal drag stress (x) at E points (N/m^2)
-         KuyE       (nx_block,ny_block,max_blocks), & ! coastal drag stress (y) at E points (N/m^2)
+         KuU        (nx_block,ny_block,max_blocks),  & ! coastal drag stress at U (B-grid)
+         KuE        (nx_block,ny_block,max_blocks),  & ! coastal drag stress at E (C-grid)
+         KuN        (nx_block,ny_block,max_blocks),  & ! coastal drag stress at N (C-grid)
+         KuxU       (nx_block,ny_block,max_blocks),  & ! coastal drag stress x-comp (U)
+         KuyU       (nx_block,ny_block,max_blocks),  & ! coastal drag stress y-comp (U)
+         KuxE       (nx_block,ny_block,max_blocks),  & ! coastal drag stress x-comp (E)
+         KuyE       (nx_block,ny_block,max_blocks),  & ! coastal drag stress y-comp (E)
+         KuxN       (nx_block,ny_block,max_blocks),  & ! coastal drag stress x-comp (N)
+         KuyN       (nx_block,ny_block,max_blocks),  & ! coastal drag stress y-comp (N)
          stat=ierr)
       if (ierr/=0) call abort_ice('(alloc_flux): Out of memory (C or CD grid)')
 
-- 
2.43.7

