From 5386f822ea2ad958435b83f6c9b94ef0bbaa9627 Mon Sep 17 00:00:00 2001
From: dpath2o <dpath2o@mac.com>
Date: Mon, 27 Oct 2025 01:33:54 +1100
Subject: [PATCH 15/34] testing CDP commit

---
 cicecore/cicedyn/dynamics/ice_dyn_evp.F90    | 97 +++++++++++++++++++-
 cicecore/cicedyn/infrastructure/ice_grid.F90 |  1 -
 2 files changed, 95 insertions(+), 3 deletions(-)

diff --git a/cicecore/cicedyn/dynamics/ice_dyn_evp.F90 b/cicecore/cicedyn/dynamics/ice_dyn_evp.F90
index d2cb0db..2f9d188 100644
--- a/cicecore/cicedyn/dynamics/ice_dyn_evp.F90
+++ b/cicecore/cicedyn/dynamics/ice_dyn_evp.F90
@@ -135,6 +135,7 @@ subroutine init_evp
       use ice_dyn_shared, only: init_dyn_shared, evp_algorithm, &
          iceEmask, iceNmask, coastal_drag, create_form_factors
       use ice_dyn_evp1d, only: dyn_evp1d_init
+      use ice_forcing, only: atm_data_type
 
 !allocate c and cd grid var. Follow structucre of eap
       integer (int_kind) :: ierr
@@ -152,7 +153,7 @@ subroutine init_evp
       call init_dyn_shared(dt_dyn)
 
       !------------------------------------------------
-      ! coastal drag masking 
+      ! coastal drag masking and form factor construction
       if (coastal_drag .and. create_form_factors) then
          do iblk = 1, nblocks
             this_block = get_block(blocks_ice(iblk), iblk)
@@ -165,7 +166,7 @@ subroutine init_evp
                enddo
             enddo
          enddo
-         call build_F2_form_factors_box_grid()
+         call build_F2_form_factors_box_grid(atm_data_type)
       endif
 
       if (evp_algorithm == "shared_mem_1d" ) then
@@ -362,6 +363,8 @@ subroutine evp (dt)
 
       character(len=*), parameter :: subname = '(evp)'
 
+      integer (kind=int_kind) :: nE, nN, nU
+
       call ice_timer_start(timer_dynamics) ! dynamics
 
       !-----------------------------------------------------------------
@@ -1039,6 +1042,51 @@ subroutine evp (dt)
             enddo  ! iblk
             !$OMP END PARALLEL DO
 
+            ! --- Diagnostics at end of subcycling ---------------------------------
+            if (ksub == ndte) then
+               nE = count(epm > c0)
+               nN = count(npm > c0)
+               nU = count(uvm > c0)
+               ! E-faces (BEFORE stepu_C)
+               write(nu_diag,9000) 'BEFORE stepu_C  F2E  min/max/avg =', &
+                  minval(F2E , mask=epm>c0),  maxval(F2E , mask=epm>c0),  &
+                  sum(F2E , mask=epm>c0)/real(max(1,nE),dbl_kind)
+               write(nu_diag,9000) 'BEFORE stepu_C  KuE  min/max/avg =', &
+                  minval(KuE , mask=epm>c0),  maxval(KuE , mask=epm>c0),  &
+                  sum(KuE , mask=epm>c0)/real(max(1,nE),dbl_kind)
+               write(nu_diag,9000) 'BEFORE stepu_C  KuxE min/max/avg =', &
+                  minval(KuxE, mask=epm>c0),  maxval(KuxE, mask=epm>c0),  &
+                  sum(KuxE, mask=epm>c0)/real(max(1,nE),dbl_kind)
+               write(nu_diag,9000) 'BEFORE stepu_C  KuyE min/max/avg =', &
+                  minval(KuyE, mask=epm>c0),  maxval(KuyE, mask=epm>c0),  &
+                  sum(KuyE, mask=epm>c0)/real(max(1,nE),dbl_kind)
+               ! N-faces (BEFORE stepv_C)
+               write(nu_diag,9000) 'BEFORE stepv_C  F2N  min/max/avg =', &
+                  minval(F2N , mask=npm>c0),  maxval(F2N , mask=npm>c0),  &
+                  sum(F2N , mask=npm>c0)/real(max(1,nN),dbl_kind)
+               write(nu_diag,9000) 'BEFORE stepv_C  KuN  min/max/avg =', &
+                  minval(KuN , mask=npm>c0),  maxval(KuN , mask=npm>c0),  &
+                  sum(KuN , mask=npm>c0)/real(max(1,nN),dbl_kind)
+               write(nu_diag,9000) 'BEFORE stepv_C  KuxN min/max/avg =', &
+                  minval(KuxN, mask=npm>c0),  maxval(KuxN, mask=npm>c0),  &
+                  sum(KuxN, mask=npm>c0)/real(max(1,nN),dbl_kind)
+               write(nu_diag,9000) 'BEFORE stepv_C  KuyN min/max/avg =', &
+                  minval(KuyN, mask=npm>c0),  maxval(KuyN, mask=npm>c0),  &
+                  sum(KuyN, mask=npm>c0)/real(max(1,nN),dbl_kind)
+               ! U-corners (BEFORE stressC_U / U-averaging)
+               write(nu_diag,9000) 'BEFORE stressC_U KuU  min/max/avg =', &
+                  minval(KuU , mask=uvm>c0),  maxval(KuU , mask=uvm>c0),  &
+                  sum(KuU , mask=uvm>c0)/real(max(1,nU),dbl_kind)
+               write(nu_diag,9000) 'BEFORE stressC_U KuxU min/max/avg =', &
+                  minval(KuxU, mask=uvm>c0),  maxval(KuxU, mask=uvm>c0),  &
+                  sum(KuxU, mask=uvm>c0)/real(max(1,nU),dbl_kind)
+               write(nu_diag,9000) 'BEFORE stressC_U KuyU min/max/avg =', &
+                  minval(KuyU, mask=uvm>c0),  maxval(KuyU, mask=uvm>c0),  &
+                  sum(KuyU, mask=uvm>c0)/real(max(1,nU),dbl_kind)
+            end if
+            9000 format(a,3(1pe16.8,1x))
+            ! ----------------------------------------------------------------------
+
             ! calls ice_haloUpdate, controls bundles and masks
             call dyn_haloUpdate (halo_info,          halo_info_mask,    &
                                  field_loc_NEcorner, field_type_scalar, &
@@ -1145,6 +1193,51 @@ subroutine evp (dt)
             enddo
             !$OMP END PARALLEL DO
 
+            ! --- Diagnostics at end of subcycling ---------------------------------
+            if (ksub == ndte) then
+               nE = count(epm > c0)
+               nN = count(npm > c0)
+               nU = count(uvm > c0)
+               ! E-faces (after stepu_C)
+               write(nu_diag,9000) 'AFTER stepu_C  F2E  min/max/avg =', &
+                  minval(F2E , mask=epm>c0),  maxval(F2E , mask=epm>c0),  &
+                  sum(F2E , mask=epm>c0)/real(max(1,nE),dbl_kind)
+               write(nu_diag,9000) 'AFTER stepu_C  KuE  min/max/avg =', &
+                  minval(KuE , mask=epm>c0),  maxval(KuE , mask=epm>c0),  &
+                  sum(KuE , mask=epm>c0)/real(max(1,nE),dbl_kind)
+               write(nu_diag,9000) 'AFTER stepu_C  KuxE min/max/avg =', &
+                  minval(KuxE, mask=epm>c0),  maxval(KuxE, mask=epm>c0),  &
+                  sum(KuxE, mask=epm>c0)/real(max(1,nE),dbl_kind)
+               write(nu_diag,9000) 'AFTER stepu_C  KuyE min/max/avg =', &
+                  minval(KuyE, mask=epm>c0),  maxval(KuyE, mask=epm>c0),  &
+                  sum(KuyE, mask=epm>c0)/real(max(1,nE),dbl_kind)
+               ! N-faces (after stepv_C)
+               write(nu_diag,9000) 'AFTER stepv_C  F2N  min/max/avg =', &
+                  minval(F2N , mask=npm>c0),  maxval(F2N , mask=npm>c0),  &
+                  sum(F2N , mask=npm>c0)/real(max(1,nN),dbl_kind)
+               write(nu_diag,9000) 'AFTER stepv_C  KuN  min/max/avg =', &
+                  minval(KuN , mask=npm>c0),  maxval(KuN , mask=npm>c0),  &
+                  sum(KuN , mask=npm>c0)/real(max(1,nN),dbl_kind)
+               write(nu_diag,9000) 'AFTER stepv_C  KuxN min/max/avg =', &
+                  minval(KuxN, mask=npm>c0),  maxval(KuxN, mask=npm>c0),  &
+                  sum(KuxN, mask=npm>c0)/real(max(1,nN),dbl_kind)
+               write(nu_diag,9000) 'AFTER stepv_C  KuyN min/max/avg =', &
+                  minval(KuyN, mask=npm>c0),  maxval(KuyN, mask=npm>c0),  &
+                  sum(KuyN, mask=npm>c0)/real(max(1,nN),dbl_kind)
+               ! U-corners (after stressC_U / U-averaging)
+               write(nu_diag,9000) 'AFTER stressC_U KuU  min/max/avg =', &
+                  minval(KuU , mask=uvm>c0),  maxval(KuU , mask=uvm>c0),  &
+                  sum(KuU , mask=uvm>c0)/real(max(1,nU),dbl_kind)
+               write(nu_diag,9000) 'AFTER stressC_U KuxU min/max/avg =', &
+                  minval(KuxU, mask=uvm>c0),  maxval(KuxU, mask=uvm>c0),  &
+                  sum(KuxU, mask=uvm>c0)/real(max(1,nU),dbl_kind)
+               write(nu_diag,9000) 'AFTER stressC_U KuyU min/max/avg =', &
+                  minval(KuyU, mask=uvm>c0),  maxval(KuyU, mask=uvm>c0),  &
+                  sum(KuyU, mask=uvm>c0)/real(max(1,nU),dbl_kind)
+            end if
+            ! ----------------------------------------------------------------------
+
+
             ! calls ice_haloUpdate, controls bundles and masks
             call dyn_haloUpdate (halo_info,       halo_info_mask,    &
                                  field_loc_Eface, field_type_vector, &
diff --git a/cicecore/cicedyn/infrastructure/ice_grid.F90 b/cicecore/cicedyn/infrastructure/ice_grid.F90
index 5bb375a..1566706 100644
--- a/cicecore/cicedyn/infrastructure/ice_grid.F90
+++ b/cicecore/cicedyn/infrastructure/ice_grid.F90
@@ -2676,7 +2676,6 @@ subroutine build_F2_form_factors_box_grid(adt_in)
             enddo
          enddo
 
-
          write(nu_diag,'(a,2es12.4,a,2es12.4)') 'build_F2: F2E(min,max)=', minval(F2E), maxval(F2E), &
                                                 '  F2N(min,max)=', minval(F2N), maxval(F2N)
          write(nu_diag,'(a,i10,a,i10)') 'build_F2: active faces:  E=', count(F2E>0.0d0), '  N=', count(F2N>0.0d0)
-- 
2.43.7

