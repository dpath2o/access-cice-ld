From f2fb58bae6eab97ccc0744ba563812831af492dc Mon Sep 17 00:00:00 2001
From: dpath2o <dpath2o@mac.com>
Date: Sat, 25 Oct 2025 05:27:50 +1100
Subject: [PATCH 12/34] CDP history outputs / diagnostic fields

---
 cicecore/cicedyn/analysis/ice_history.F90     | 55 ++++++++++++++++++-
 .../cicedyn/analysis/ice_history_shared.F90   | 17 +++++-
 cicecore/cicedyn/dynamics/ice_dyn_shared.F90  | 11 +++-
 3 files changed, 75 insertions(+), 8 deletions(-)

diff --git a/cicecore/cicedyn/analysis/ice_history.F90 b/cicecore/cicedyn/analysis/ice_history.F90
index a6eabe2..60191e8 100644
--- a/cicecore/cicedyn/analysis/ice_history.F90
+++ b/cicecore/cicedyn/analysis/ice_history.F90
@@ -454,6 +454,12 @@ subroutine init_hist (dt)
          f_taubyN = f_tauby
          f_taubxE = f_taubx
          f_taubyE = f_tauby
+         f_KuxN   = f_Kux
+         f_KuyN   = f_Kuy
+         f_KuxE   = f_Kux
+         f_KuyE   = f_Kuy
+         f_F2E    = f_uvel
+         f_F2N    = f_uvel
       endif
 
       call broadcast_scalar (f_tlon, master_task)
@@ -692,6 +698,12 @@ subroutine init_hist (dt)
       call broadcast_scalar (f_sistreave, master_task)
       call broadcast_scalar (f_sistremax, master_task)
       call broadcast_scalar (f_sirdgthick, master_task)
+      call broadcast_scalar (f_KuxN, master_task)
+      call broadcast_scalar (f_KuyN, master_task)
+      call broadcast_scalar (f_KuxE, master_task)
+      call broadcast_scalar (f_KuyE, master_task)
+      call broadcast_scalar (f_F2N, master_task)
+      call broadcast_scalar (f_F2E, master_task)
 
       call broadcast_scalar (f_aicen, master_task)
       call broadcast_scalar (f_vicen, master_task)
@@ -1345,6 +1357,31 @@ subroutine init_hist (dt)
              "vort is instantaneous, on T grid", secday*c100, c0,                                &
              ns1, f_vort)
 
+        ! coastal drag 
+        call define_hist_field(n_KuxN,"KuxN","N/m^2",nstr2D, ncstr, &
+            "coastal (lateral) drag stress (x)", &
+            "positive is x direction on N grid", c1, c0, ns1, f_KuxN)
+
+        call define_hist_field(n_KuyN,"KuyN","N/m^2",nstr2D, ncstr, &
+            "coastal (lateral) drag stress (y)", &
+            "positive is y direction on N grid", c1, c0, ns1, f_KuyN)
+
+        call define_hist_field(n_KuxE,"KuxE","N/m^2",estr2D, ecstr, &
+            "coastal (lateral) drag stress (x)", &
+            "positive is x direction on E grid", c1, c0, ns1, f_KuxE)
+
+        call define_hist_field(n_KuyE,"KuyE","N/m^2",estr2D, ecstr, &
+            "coastal (lateral) drag stress (y)", &
+            "positive is y direction on E grid", c1, c0, ns1, f_KuyE)
+
+        call define_hist_field(n_F2N, "F2N", "-", nstr2D, ncstr, &
+            "coastal drag form factor (unitless)", &
+            "static; N-face on C-grid", c1, c0, ns1, f_F2N)
+
+        call define_hist_field(n_F2E, "F2E", "-", estr2D, ecstr, &
+            "coastal drag form factor (unitless)", &
+            "static; E-face on C-grid", c1, c0, ns1, f_F2E)
+
          select case (grid_ice)
          case('B')
             description = ", on U grid  (NE corner values)"
@@ -2156,7 +2193,7 @@ subroutine accum_hist (dt)
       use ice_blocks, only: block, get_block, nx_block, ny_block
       use ice_domain, only: blocks_ice, nblocks
       use ice_domain_size, only: nfsd
-      use ice_grid, only: tmask, lmask_n, lmask_s, dxU, dyU, grid_ice
+      use ice_grid, only: tmask, lmask_n, lmask_s, dxU, dyU, grid_ice, F2E, F2N
       use ice_calendar, only: new_year, write_history, &
                               write_ic, timesecs, histfreq, nstreams, mmonth, &
                               new_month
@@ -2182,7 +2219,8 @@ subroutine accum_hist (dt)
           stressp_2, stressp_3, stressp_4, sig1, sig2, sigP, &
           mlt_onset, frz_onset, dagedtt, dagedtd, fswint_ai, keffn_top, &
           snowfrac, alvdr_ai, alvdf_ai, alidr_ai, alidf_ai, update_ocn_f, &
-          cpl_frazil
+          cpl_frazil, &
+          KuxN, KuyN, KuxE, KuyE
       use ice_arrays_column, only: snowfracn, Cdn_atm
       use ice_history_shared ! almost everything
       use ice_history_write, only: ice_write_hist
@@ -2670,6 +2708,19 @@ subroutine accum_hist (dt)
          if (f_strength(1:1)/= 'x') &
              call accum_hist_field(n_strength,iblk, strength(:,:,iblk), a2D)
 
+         if (f_KuxN(1:1) /= 'x') &
+             call accum_hist_field(n_KuxN, iblk, KuxN(:,:,iblk), a2D)
+         if (f_KuyN(1:1) /= 'x') &
+             call accum_hist_field(n_KuyN, iblk, KuyN(:,:,iblk), a2D)
+         if (f_KuxE(1:1) /= 'x') &
+             call accum_hist_field(n_KuxE, iblk, KuxE(:,:,iblk), a2D)
+         if (f_KuyE(1:1) /= 'x') &
+             call accum_hist_field(n_KuyE, iblk, KuyE(:,:,iblk), a2D)
+         if (f_F2N(1:1) /= 'x') &
+             call accum_hist_field(n_F2N, iblk, F2N(:,:,iblk), a2D)
+         if (f_F2E(1:1) /= 'x') &
+             call accum_hist_field(n_F2E, iblk, F2E(:,:,iblk), a2D)
+             
 ! The following fields (divu, shear, vort, sig1, and sig2) will be smeared
 !  if averaged over more than a few days.
 ! Snapshots may be more useful (see below).
diff --git a/cicecore/cicedyn/analysis/ice_history_shared.F90 b/cicecore/cicedyn/analysis/ice_history_shared.F90
index daa8057..794245f 100644
--- a/cicecore/cicedyn/analysis/ice_history_shared.F90
+++ b/cicecore/cicedyn/analysis/ice_history_shared.F90
@@ -362,7 +362,11 @@ module ice_history_shared
            f_s22       = 'x', &
            f_yieldstress11  = 'x', &
            f_yieldstress12  = 'x', &
-           f_yieldstress22  = 'x'
+           f_yieldstress22  = 'x', &
+           f_Kux  = 'x', f_Kuy  = 'x', &
+           f_KuxN = 'x', f_KuyN = 'x', &
+           f_KuxE = 'x', f_KuyE = 'x', &
+           f_F2N  = 'x', f_F2E  = 'x'
 
       !---------------------------------------------------------------
       ! namelist variables
@@ -534,7 +538,10 @@ module ice_history_shared
            f_s22,       &
            f_yieldstress11, &
            f_yieldstress12, &
-           f_yieldstress22
+           f_yieldstress22, &
+           f_Kux , f_Kuy, f_F2N, f_F2E , &
+           f_KuxN, f_KuyN, &
+           f_KuxE, f_KuyE
 
       !---------------------------------------------------------------
       ! field indices
@@ -735,7 +742,11 @@ module ice_history_shared
            n_s11         , n_s12       , &
            n_s22         , &
            n_yieldstress11, n_yieldstress12, &
-           n_yieldstress22
+           n_yieldstress22, &
+           n_Kux , n_Kuy , &
+           n_KuxN, n_KuyN, &
+           n_KuxE, n_KuyE, &
+           n_F2N , n_F2E
 
       interface accum_hist_field ! generic interface
            module procedure accum_hist_field_2D, &
diff --git a/cicecore/cicedyn/dynamics/ice_dyn_shared.F90 b/cicecore/cicedyn/dynamics/ice_dyn_shared.F90
index 0855fa0..70fadf5 100644
--- a/cicecore/cicedyn/dynamics/ice_dyn_shared.F90
+++ b/cicecore/cicedyn/dynamics/ice_dyn_shared.F90
@@ -148,6 +148,9 @@ module ice_dyn_shared
          coastal_drag, &     ! if true, coastal drag stress for landfast on
          create_form_factors ! if true, create the coastal form factors using the coastline
 
+      real(kind=dbl_kind), dimension(:,:,:), allocatable, public :: &
+         F2     ! coastal form factors
+
       ! character (len=char_len), public :: &
       !    coastline_file       ! NetCDF of coastline
 
@@ -155,6 +158,8 @@ module ice_dyn_shared
          Cs, &  ! static function coefficient; Liu et al. (2022) eq.13; 1.0*10^{âˆ’4} m/s^2
          u0     ! residual velocity for coastal drag stress (and seabed stress) (m/s)
 
+
+
       interface strain_rates_T
          module procedure strain_rates_Tdt
          module procedure strain_rates_Tdtsd
@@ -1592,9 +1597,9 @@ subroutine coastal_drag_stress_factor(nx_block, ny_block, &
       real (kind=dbl_kind), dimension (nx_block,ny_block), intent(inout) :: &
          Ku       ! coastal drag stress factor (N/m^2)
       ! (optional but handy: print once on master)
-      ! if (my_task == master_task) then
-      !    write(nu_diag, '(a,2f12.5)') 'ice_dyn_shared.F90 F2(min,max)=', minval(F2), maxval(F2)
-      ! endif
+      if (my_task == master_task) then
+          write(nu_diag, '(a,2f12.5)') 'ice_dyn_shared.F90 F2(min,max)=', minval(F2), maxval(F2)
+      endif
       do ij = 1, icellU
          i       = indxUi(ij)
          j       = indxUj(ij)
-- 
2.43.7

