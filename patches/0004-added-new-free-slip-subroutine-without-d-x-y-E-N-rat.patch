From 8965420ab6dca7eb957644be577c23e1e7f04c1b Mon Sep 17 00:00:00 2001
From: dpath2o <dpath2o@mac.com>
Date: Wed, 22 Oct 2025 05:30:23 +1100
Subject: [PATCH 04/34] added new free-slip subroutine without d[x|y][E|N]
 ratios

---
 cicecore/cicedyn/dynamics/ice_dyn_evp.F90    |  21 +++-
 cicecore/cicedyn/dynamics/ice_dyn_shared.F90 | 115 ++++++++++++++++++-
 2 files changed, 132 insertions(+), 4 deletions(-)

diff --git a/cicecore/cicedyn/dynamics/ice_dyn_evp.F90 b/cicecore/cicedyn/dynamics/ice_dyn_evp.F90
index 5fa1fd4..3f1748f 100644
--- a/cicecore/cicedyn/dynamics/ice_dyn_evp.F90
+++ b/cicecore/cicedyn/dynamics/ice_dyn_evp.F90
@@ -291,7 +291,7 @@ subroutine evp (dt)
           DminTarea, visc_method, deformations, deformationsC_T, deformationsCD_T, &
           strain_rates_U, dxhy, dyhx, cxp, cyp, cxm, cym, &
           iceTmask, iceUmask, iceEmask, iceNmask, &
-          dyn_haloUpdate, fld2, fld3, fld4, strain_rates_U_free_slip
+          dyn_haloUpdate, fld2, fld3, fld4, strain_rates_U_free_slip, strain_rates_U_free_slip_noratio
       use ice_dyn_evp1d, only: dyn_evp1d_run
 
       real (kind=dbl_kind), intent(in) :: &
@@ -940,7 +940,21 @@ subroutine evp (dt)
             ! strain rates at U point
             ! NOTE these are actually strain rates * area  (m^2/s)
             !-----------------------------------------------------------------
-               call strain_rates_U_free_slip (nx_block          , ny_block           , &
+               ! call strain_rates_U_free_slip (nx_block          , ny_block           , &
+               !                      icellU      (iblk),                      &
+               !                      indxUi    (:,iblk), indxUj     (:,iblk), &
+               !                      uvelE   (:,:,iblk), vvelE    (:,:,iblk), &
+               !                      uvelN   (:,:,iblk), vvelN    (:,:,iblk), &
+               !                      uvel    (:,:,iblk), vvel     (:,:,iblk), &
+               !                      dxE     (:,:,iblk), dyN      (:,:,iblk), &
+               !                      dxU     (:,:,iblk), dyU      (:,:,iblk), &
+               !                      ratiodxN(:,:,iblk), ratiodxNr(:,:,iblk), &
+               !                      ratiodyE(:,:,iblk), ratiodyEr(:,:,iblk), &
+               !                      epm     (:,:,iblk), npm      (:,:,iblk), &
+               !                      divergU (:,:,iblk), tensionU (:,:,iblk), &
+               !                      shearU  (:,:,iblk), deltaU   (:,:,iblk), &
+               !                      ksub              , ndte                 )
+               call strain_rates_U_free_slip_noratio (nx_block          , ny_block           , &
                                     icellU      (iblk),                      &
                                     indxUi    (:,iblk), indxUj     (:,iblk), &
                                     uvelE   (:,:,iblk), vvelE    (:,:,iblk), &
@@ -952,7 +966,8 @@ subroutine evp (dt)
                                     ratiodyE(:,:,iblk), ratiodyEr(:,:,iblk), &
                                     epm     (:,:,iblk), npm      (:,:,iblk), &
                                     divergU (:,:,iblk), tensionU (:,:,iblk), &
-                                    shearU  (:,:,iblk), deltaU   (:,:,iblk)  )
+                                    shearU  (:,:,iblk), deltaU   (:,:,iblk), &
+                                    ksub              , ndte                 )
                ! call strain_rates_U (nx_block          , ny_block           , &
                !                      icellU      (iblk),                      &
                !                      indxUi    (:,iblk), indxUj     (:,iblk), &
diff --git a/cicecore/cicedyn/dynamics/ice_dyn_shared.F90 b/cicecore/cicedyn/dynamics/ice_dyn_shared.F90
index 9ff4d9c..49c3550 100644
--- a/cicecore/cicedyn/dynamics/ice_dyn_shared.F90
+++ b/cicecore/cicedyn/dynamics/ice_dyn_shared.F90
@@ -28,6 +28,7 @@ module ice_dyn_shared
                 seabed_stress_factor_LKD, seabed_stress_factor_prob, &
                 deformations, deformationsC_T, deformationsCD_T, &
                 strain_rates, strain_rates_T, strain_rates_U, strain_rates_U_free_slip, &
+                strain_rates_U_free_slip_noratio, &
                 visc_replpress, &
                 dyn_haloUpdate, &
                 stack_fields, unstack_fields
@@ -2519,7 +2520,119 @@ subroutine strain_rates_U_free_slip(nx_block, ny_block,  &
          call flush(nu_diag)
       end if
 
-end subroutine strain_rates_U_free_slip
+   end subroutine strain_rates_U_free_slip
+
+!=======================================================================
+! Compute strain rates at the U point for Neumann boundary conditions
+! "free-slip" (no distance ratios; even reflection with unit factor)
+!
+! author: dpath2o (per request), Oct 2025
+! Notes:
+!  - When a neighbor face is land, substitute the interior face with
+!    an even reflection of *unit* magnitude (i.e., ghost = +interior).
+!  - Normal components are already handled elsewhere (impermeable wall
+!    u_n = 0 at faces before strains), so here we only need the even
+!    continuation so that the normal derivative of the tangential
+!    component vanishes at the wall.
+!  - Signature kept identical to the no-slip routine.
+!=======================================================================
+      subroutine strain_rates_U_free_slip_noratio(nx_block, ny_block,  &
+                                          icellU,              &
+                                          indxUi,   indxUj,    &
+                                          uvelE,    vvelE,     &
+                                          uvelN,    vvelN,     &
+                                          uvelU,    vvelU,     &
+                                          dxE,      dyN,       &
+                                          dxU,      dyU,       &
+                                          ratiodxN, ratiodxNr, &  ! <unused> kept for signature compat
+                                          ratiodyE, ratiodyEr, &  ! <unused> kept for signature compat
+                                          epm,      npm,       &
+                                          divergU,  tensionU,  &
+                                          shearU,   DeltaU,    &
+                                          ksub,     ndte)
+
+         character(len=*), parameter :: subname = '(strain_rates_U_free_slip_noratio)'
+         integer (kind=int_kind), intent(in) :: nx_block, ny_block, icellU
+         integer (kind=int_kind), intent(in) :: ksub, ndte
+         integer (kind=int_kind), dimension (nx_block*ny_block), intent(in) :: indxUi, indxUj
+
+         real (kind=dbl_kind), dimension (nx_block,ny_block), intent(in) :: &
+            uvelE, vvelE, uvelN, vvelN, uvelU, vvelU, dxE, dyN, dxU, dyU, &
+            ratiodxN, ratiodxNr, ratiodyE, ratiodyEr, epm, npm   ! ratios unused
+
+         real (kind=dbl_kind), dimension (nx_block,ny_block), intent(out) :: &
+            divergU, tensionU, shearU, DeltaU
+
+         integer (kind=int_kind) :: ij, i, j
+         ! face values used in centered differences
+         real (kind=dbl_kind) :: uNip1j, uNij, vEijp1, vEij, uEijp1, uEij, vNip1j, vNij
+
+         ! zero outputs
+         divergU(:,:) = c0
+         tensionU(:,:) = c0
+         shearU(:,:)   = c0
+         DeltaU(:,:)   = c0
+
+         !---------------------------------------------------------------
+         ! Free-slip stencil at U without distance ratios:
+         ! If the neighbor face is land, use even reflection with unit
+         ! factor: ghost = + interior. Implemented via mask switches.
+         !---------------------------------------------------------------
+         do ij = 1, icellU
+            i = indxUi(ij)
+            j = indxUj(ij)
+
+            ! --- “dv/dx” part on E-grid uses (i,j+1) and (i,j) samples
+            ! If epm(i,j+1)==0 and epm(i,j)==1 -> substitute vE(i,j+1) := +vE(i,j)
+            vEijp1 = vvelE(i,j+1)*epm(i,j+1) + (epm(i,j)   - epm(i,j+1)) * epm(i,j)   * vvelE(i,j)
+            vEij   = vvelE(i,j  )*epm(i,j  ) + (epm(i,j+1) - epm(i,j  ) ) * epm(i,j+1) * vvelE(i,j+1)
+
+            ! --- “du/dx or du/dy” part on N-grid using (i+1,j) and (i,j)
+            ! If npm(i+1,j)==0 and npm(i,j)==1 -> substitute uN(i+1,j) := +uN(i,j)
+            uNip1j = uvelN(i+1,j)*npm(i+1,j) + (npm(i,j)   - npm(i+1,j)) * npm(i,j)   * uvelN(i  ,j)
+            uNij   = uvelN(i  ,j)*npm(i  ,j) + (npm(i+1,j) - npm(i  ,j) ) * npm(i+1,j) * uvelN(i+1,j)
+
+            ! divergence  =  e_11 + e_22
+            divergU(i,j) = dyU(i,j)   * (uNip1j - uNij)   + uvelU(i,j) * (dyN(i+1,j) - dyN(i,j)) &
+                        +  dxU(i,j)   * (vEijp1 - vEij)   + vvelU(i,j) * (dxE(i  ,j+1) - dxE(i,j))
+
+            ! tension = e_11 - e_22
+            tensionU(i,j)= dyU(i,j)   * (uNip1j - uNij)   - uvelU(i,j) * (dyN(i+1,j) - dyN(i,j)) &
+                        -  dxU(i,j)   * (vEijp1 - vEij)   + vvelU(i,j) * (dxE(i  ,j+1) - dxE(i,j))
+
+            ! --- “du/dy or du/dx” on E-grid for u
+            uEijp1 = uvelE(i,j+1)*epm(i,j+1) + (epm(i,j)   - epm(i,j+1)) * epm(i,j)   * uvelE(i  ,j)
+            uEij   = uvelE(i,j  )*epm(i,j  ) + (epm(i,j+1) - epm(i,j  ) ) * epm(i,j+1) * uvelE(i  ,j+1)
+
+            ! --- “dv/dy” on N-grid for v
+            vNip1j = vvelN(i+1,j)*npm(i+1,j) + (npm(i,j)   - npm(i+1,j)) * npm(i,j)   * vvelN(i  ,j)
+            vNij   = vvelN(i  ,j)*npm(i  ,j) + (npm(i+1,j) - npm(i  ,j) ) * npm(i+1,j) * vvelN(i+1,j)
+
+            ! shear = 2 e_12
+            shearU(i,j) =  dxU(i,j) * (uEijp1 - uEij) - uvelU(i,j) * (dxE(i  ,j+1) - dxE(i,j))  &
+                        + dyU(i,j) * (vNip1j - vNij) - vvelU(i,j) * (dyN(i+1,j) - dyN(i,j))
+
+            ! Delta for viscosities
+            DeltaU(i,j) = sqrt( divergU(i,j)**2 + e_factor * ( tensionU(i,j)**2 + shearU(i,j)**2 ) )
+         end do
+
+         ! ---------- Diagnostics: print coastal U only (last subcycle) ----------
+         if (ksub == ndte) then
+            do j = 2, ny_block-1
+               do i = 2, nx_block-1
+                  ! U(i,j) is “coastal” if any of its four surrounding faces is land
+                  if ( epm(i  ,j  ) == c0 .or. epm(i  ,j-1) == c0 .or. &
+                     npm(i  ,j  ) == c0 .or. npm(i-1,j  ) == c0 ) then
+                     !$OMP CRITICAL (IO_DIAG)
+                     write(nu_diag,'(a,2i6,1p,e16.8)') 'free-slip U-coast shearU  (i,j)=', i, j, shearU(i,j)
+                     !$OMP END CRITICAL (IO_DIAG)
+                  end if
+               end do
+            end do
+            call flush(nu_diag)
+         end if
+
+      end subroutine strain_rates_U_free_slip_noratio
 
 !=======================================================================
 ! Computes viscosities and replacement pressure for stress
-- 
2.43.7

