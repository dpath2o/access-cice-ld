From f79f0863c4aaeb99ec230c55e70727f40bb67de9 Mon Sep 17 00:00:00 2001
From: dpath2o <dpath2o@mac.com>
Date: Mon, 27 Oct 2025 07:05:47 +1100
Subject: [PATCH 19/34] CDP testing

---
 cicecore/cicedyn/dynamics/ice_dyn_evp.F90    | 66 +++++++++++---------
 cicecore/cicedyn/dynamics/ice_dyn_shared.F90 | 17 ++---
 cicecore/cicedyn/infrastructure/ice_grid.F90 | 23 ++++---
 3 files changed, 58 insertions(+), 48 deletions(-)

diff --git a/cicecore/cicedyn/dynamics/ice_dyn_evp.F90 b/cicecore/cicedyn/dynamics/ice_dyn_evp.F90
index 97145ad..d19c920 100644
--- a/cicecore/cicedyn/dynamics/ice_dyn_evp.F90
+++ b/cicecore/cicedyn/dynamics/ice_dyn_evp.F90
@@ -130,10 +130,10 @@ subroutine init_evp
       use ice_domain_size, only: max_blocks
       use ice_domain, only: nblocks, blocks_ice
       use ice_grid, only: grid_ice, dyT, dxT, uarear, tmask, G_HTE, G_HTN, dxN, dyE, &
-         build_F2_form_factors_cgrid, F2E, F2N
+         build_F2_form_factors_cgrid
       use ice_calendar, only: dt_dyn
       use ice_dyn_shared, only: init_dyn_shared, evp_algorithm, &
-         iceEmask, iceNmask, coastal_drag, create_form_factors
+         iceEmask, iceNmask, coastal_drag, create_form_factors, F2E, F2N, cdp_ff_built
       use ice_dyn_evp1d, only: dyn_evp1d_init
 
 !allocate c and cd grid var. Follow structucre of eap
@@ -154,22 +154,25 @@ subroutine init_evp
       !------------------------------------------------
       ! coastal drag masking and form factor construction
       if (coastal_drag .and. create_form_factors) then
-         ! do iblk = 1, nblocks
-         !    this_block = get_block(blocks_ice(iblk), iblk)
-         !    ilo = this_block%ilo;  ihi = this_block%ihi
-         !    jlo = this_block%jlo;  jhi = this_block%jhi
-         !    do j = jlo, jhi
-         !       do i = ilo, ihi
-         !          iceEmask(i,j,iblk) = tmask(i,j,iblk) .or. tmask(i+1,j,iblk)
-         !          iceNmask(i,j,iblk) = tmask(i,j,iblk) .or. tmask(i,j+1,iblk)
-         !       enddo
-         !    enddo
-         ! enddo
-         if (.not. allocated(F2E)) allocate(F2E(nx_block,ny_block,max_blocks))
-         if (.not. allocated(F2N)) allocate(F2N(nx_block,ny_block,max_blocks))
-         call build_F2_form_factors_cgrid(F2E, F2N, test_case=.true.)
-         !call build_F2_form_factors_cgrid()
+         call build_F2_form_factors_cgrid(test_case=.true.)   ! perimeter fallback for your 12Ã—12 ocean box
       endif
+      ! if (coastal_drag .and. create_form_factors) then
+      !    ! do iblk = 1, nblocks
+      !    !    this_block = get_block(blocks_ice(iblk), iblk)
+      !    !    ilo = this_block%ilo;  ihi = this_block%ihi
+      !    !    jlo = this_block%jlo;  jhi = this_block%jhi
+      !    !    do j = jlo, jhi
+      !    !       do i = ilo, ihi
+      !    !          iceEmask(i,j,iblk) = tmask(i,j,iblk) .or. tmask(i+1,j,iblk)
+      !    !          iceNmask(i,j,iblk) = tmask(i,j,iblk) .or. tmask(i,j+1,iblk)
+      !    !       enddo
+      !    !    enddo
+      !    ! enddo
+      !    if (.not. allocated(F2E)) allocate(F2E(nx_block,ny_block,max_blocks))
+      !    if (.not. allocated(F2N)) allocate(F2N(nx_block,ny_block,max_blocks))
+      !    call build_F2_form_factors_cgrid(F2E, F2N, test_case=.true.)
+      !    !call build_F2_form_factors_cgrid()
+      ! endif
 
       if (evp_algorithm == "shared_mem_1d" ) then
          call dyn_evp1d_init
@@ -304,8 +307,8 @@ subroutine evp (dt)
       use ice_grid, only: tmask, umask, umaskCD, nmask, emask, uvm, epm, npm, &
           dxE, dxN, dxT, dxU, dyE, dyN, dyT, dyU, &
           tarear, uarear, earear, narear, grid_average_X2Y, uarea, &
-          grid_ice, grid_atm_dynu, grid_atm_dynv, grid_ocn_dynu, grid_ocn_dynv, &
-          F2E, F2N
+          grid_ice, grid_atm_dynu, grid_atm_dynv, grid_ocn_dynu, grid_ocn_dynv!, &
+          !F2E, F2N
       use ice_state, only: aice, aiU, vice, vsno, uvel, vvel, uvelN, vvelN, &
           uvelE, vvelE, divu, shear, vort, &
           aice_init, aice0, aicen, vicen, strength
@@ -315,7 +318,8 @@ subroutine evp (dt)
           DminTarea, visc_method, deformations, deformationsC_T, deformationsCD_T, &
           strain_rates_U_no_slip, strain_rates_U_free_slip, dxhy, dyhx, cxp, cyp, cxm, cym, &
           iceTmask, iceUmask, iceEmask, iceNmask, &
-          dyn_haloUpdate, fld2, fld3, fld4
+          dyn_haloUpdate, fld2, fld3, fld4, &
+          F2E, F2N, cdp_ff_built
       use ice_dyn_evp1d, only: dyn_evp1d_run
 
       real (kind=dbl_kind), intent(in) :: &
@@ -824,39 +828,39 @@ subroutine evp (dt)
             nN = count(npm > c0)
             nU = count(uvm > c0)
             ! E-faces (AT CDP CALL stepu_C)
-            write(nu_diag,9000) 'AT CDP CALL stepu_C  F2E  min/max/avg =', &
+            write(nu_diag,9000) 'AT CDP CAL F2E  min/max/avg =', &
                minval(F2E , mask=epm>c0),  maxval(F2E , mask=epm>c0),  &
                sum(F2E , mask=epm>c0)/real(max(1,nE),dbl_kind)
-            write(nu_diag,9000) 'AT CDP CALL stepu_C  KuE  min/max/avg =', &
+            write(nu_diag,9000) 'AT CDP CALL KuE  min/max/avg =', &
                minval(KuE , mask=epm>c0),  maxval(KuE , mask=epm>c0),  &
                sum(KuE , mask=epm>c0)/real(max(1,nE),dbl_kind)
-            write(nu_diag,9000) 'AT CDP CALL stepu_C  KuxE min/max/avg =', &
+            write(nu_diag,9000) 'AT CDP CALL KuxE min/max/avg =', &
                minval(KuxE, mask=epm>c0),  maxval(KuxE, mask=epm>c0),  &
                sum(KuxE, mask=epm>c0)/real(max(1,nE),dbl_kind)
-            write(nu_diag,9000) 'AT CDP CALL stepu_C  KuyE min/max/avg =', &
+            write(nu_diag,9000) 'AT CDP CALL KuyE min/max/avg =', &
                minval(KuyE, mask=epm>c0),  maxval(KuyE, mask=epm>c0),  &
                sum(KuyE, mask=epm>c0)/real(max(1,nE),dbl_kind)
             ! N-faces (AT CDP CALL stepv_C)
-            write(nu_diag,9000) 'AT CDP CALL stepv_C  F2N  min/max/avg =', &
+            write(nu_diag,9000) 'AT CDP CALL F2N  min/max/avg =', &
                minval(F2N , mask=npm>c0),  maxval(F2N , mask=npm>c0),  &
                sum(F2N , mask=npm>c0)/real(max(1,nN),dbl_kind)
-            write(nu_diag,9000) 'AT CDP CALL stepv_C  KuN  min/max/avg =', &
+            write(nu_diag,9000) 'AT CDP CALL KuN  min/max/avg =', &
                minval(KuN , mask=npm>c0),  maxval(KuN , mask=npm>c0),  &
                sum(KuN , mask=npm>c0)/real(max(1,nN),dbl_kind)
-            write(nu_diag,9000) 'AT CDP CALL stepv_C  KuxN min/max/avg =', &
+            write(nu_diag,9000) 'AT CDP CALL KuxN min/max/avg =', &
                minval(KuxN, mask=npm>c0),  maxval(KuxN, mask=npm>c0),  &
                sum(KuxN, mask=npm>c0)/real(max(1,nN),dbl_kind)
-            write(nu_diag,9000) 'AT CDP CALL stepv_C  KuyN min/max/avg =', &
+            write(nu_diag,9000) 'AT CDP CALL KuyN min/max/avg =', &
                minval(KuyN, mask=npm>c0),  maxval(KuyN, mask=npm>c0),  &
                sum(KuyN, mask=npm>c0)/real(max(1,nN),dbl_kind)
             ! U-corners (AT CDP CALL stressC_U / U-averaging)
-            write(nu_diag,9000) 'AT CDP CALL stressC_U KuU  min/max/avg =', &
+            write(nu_diag,9000) 'AT CDP CALL KuU  min/max/avg =', &
                minval(KuU , mask=uvm>c0),  maxval(KuU , mask=uvm>c0),  &
                sum(KuU , mask=uvm>c0)/real(max(1,nU),dbl_kind)
-            write(nu_diag,9000) 'AT CDP CALL stressC_U KuxU min/max/avg =', &
+            write(nu_diag,9000) 'AT CDP CALL KuxU min/max/avg =', &
                minval(KuxU, mask=uvm>c0),  maxval(KuxU, mask=uvm>c0),  &
                sum(KuxU, mask=uvm>c0)/real(max(1,nU),dbl_kind)
-            write(nu_diag,9000) 'AT CDP CALL stressC_U KuyU min/max/avg =', &
+            write(nu_diag,9000) 'AT CDP CALL KuyU min/max/avg =', &
                minval(KuyU, mask=uvm>c0),  maxval(KuyU, mask=uvm>c0),  &
                sum(KuyU, mask=uvm>c0)/real(max(1,nU),dbl_kind)
             9000 format(a,3(1pe16.8,1x))
diff --git a/cicecore/cicedyn/dynamics/ice_dyn_shared.F90 b/cicecore/cicedyn/dynamics/ice_dyn_shared.F90
index 928dab3..8f379cd 100644
--- a/cicecore/cicedyn/dynamics/ice_dyn_shared.F90
+++ b/cicecore/cicedyn/dynamics/ice_dyn_shared.F90
@@ -17,7 +17,6 @@ module ice_dyn_shared
       use ice_domain_size, only: max_blocks
       use ice_fileunits, only: nu_diag
       use ice_exit, only: abort_ice
-      use ice_grid, only: grid_ice
       use icepack_intfc, only: icepack_warnings_flush, icepack_warnings_aborted
       use icepack_intfc, only: icepack_query_parameters
 
@@ -148,8 +147,12 @@ module ice_dyn_shared
          coastal_drag, &     ! if true, coastal drag stress for landfast on
          create_form_factors ! if true, create the coastal form factors using the coastline
 
+      ! real(kind=dbl_kind), dimension(:,:,:), allocatable, public :: &
+      !    F2_loc     ! coastal form factors
+      
       real(kind=dbl_kind), dimension(:,:,:), allocatable, public :: &
-         F2     ! coastal form factors
+         F2E(:,:,:), F2N(:,:,:)
+      logical(kind=log_kind),       public, save :: cdp_ff_built = .false._log_kind
 
       ! character (len=char_len), public :: &
       !    coastline_file       ! NetCDF of coastline
@@ -1574,7 +1577,7 @@ subroutine coastal_drag_stress_factor(nx_block, ny_block, &
                                             indxUi  , indxUj  , &
                                             imass   ,           &
                                             Ku      ,           & 
-                                            F2                  ) 
+                                            F2_loc              ) 
       character(len=*), parameter :: subname = '(coastal_drag_stress_factor)'
       ! blocks:
       integer (kind=int_kind), intent(in) :: &
@@ -1589,19 +1592,19 @@ subroutine coastal_drag_stress_factor(nx_block, ny_block, &
       ! sea ice variables: 
       real (kind=dbl_kind), dimension (nx_block,ny_block), intent(in) :: &
          imass, & ! total mass of sea ice (includes snow) at E or N grid points
-         F2       ! coastline form factor -- computed offline; (N/m^2)
+         F2_loc       ! coastline form factor -- computed offline; (N/m^2)
       ! compute Ku at each grid point 
-      ! (away from the coast it should go to zero as F2 goes to zero)
+      ! (away from the coast it should go to zero as F2_loc goes to zero)
       real (kind=dbl_kind), dimension (nx_block,ny_block), intent(inout) :: &
          Ku       ! coastal drag stress factor (N/m^2)
       ! (optional but handy: print once on master)
       if (my_task == master_task) then
-          write(nu_diag, '(a,2f12.5)') 'ice_dyn_shared.F90 F2(min,max)=', minval(F2), maxval(F2)
+          write(nu_diag, '(a,2f12.5)') 'ice_dyn_shared.F90 F2_loc(min,max)=', minval(F2_loc), maxval(F2_loc)
       endif
       do ij = 1, icellU
          i       = indxUi(ij)
          j       = indxUj(ij)
-         Ku(i,j) = imass(i,j) * F2(i,j) * Cs
+         Ku(i,j) = imass(i,j) * F2_loc(i,j) * Cs
       enddo ! ij
       end subroutine coastal_drag_stress_factor
 
diff --git a/cicecore/cicedyn/infrastructure/ice_grid.F90 b/cicecore/cicedyn/infrastructure/ice_grid.F90
index e392d0d..18bb196 100644
--- a/cicecore/cicedyn/infrastructure/ice_grid.F90
+++ b/cicecore/cicedyn/infrastructure/ice_grid.F90
@@ -2610,12 +2610,13 @@ end subroutine rectgrid_scale_dxdy
 
 
 !=======================================================================
-subroutine build_F2_form_factors_cgrid(F2E, F2N, coast_file, coast_var, F2_value, test_case)
+subroutine build_F2_form_factors_cgrid(coast_file, coast_var, F2_value, test_case)
    use ice_kinds_mod
-   use ice_blocks       , only: get_block, nx_block, ny_block, block
-   use ice_domain       , only: nblocks, blocks_ice
-   use ice_domain_size  , only: max_blocks
-   use ice_fileunits    , only: nu_diag
+   use ice_blocks     , only: get_block, nx_block, ny_block, block
+   use ice_domain     , only: nblocks, blocks_ice
+   use ice_domain_size, only: max_blocks
+   use ice_fileunits  , only: nu_diag
+   use ice_dyn_shared , only: F2E, F2N, cdp_ff_built 
 #ifdef _NETCDF
    use netcdf
 #endif
@@ -2626,9 +2627,9 @@ subroutine build_F2_form_factors_cgrid(F2E, F2N, coast_file, coast_var, F2_value
    real   (kind=dbl_kind),   intent(in), optional :: F2_value    ! default 0.25
    logical(kind=log_kind),   intent(in), optional :: test_case   ! if true and no coast_file, treat perimeter as coastline
 
-   ! ---- REQUIRED outputs (already allocated by caller) ----
-   real(kind=dbl_kind), intent(inout) :: F2E(nx_block,ny_block,max_blocks)
-   real(kind=dbl_kind), intent(inout) :: F2N(nx_block,ny_block,max_blocks)
+   ! ! ---- REQUIRED outputs (already allocated by caller) ----
+   ! real(kind=dbl_kind), intent(out) :: F2E(nx_block,ny_block,max_blocks)
+   ! real(kind=dbl_kind), intent(out) :: F2N(nx_block,ny_block,max_blocks)
 
    ! ----- locals -----
    type(block)               :: this_block
@@ -2653,8 +2654,8 @@ subroutine build_F2_form_factors_cgrid(F2E, F2N, coast_file, coast_var, F2_value
    want_perimeter = .false.; if (present(test_case)) want_perimeter = test_case
 
    ! ----- allocate/clear outputs -----
-   ! if (.not. allocated(F2E)) allocate(F2E(nx_block,ny_block,max_blocks))
-   ! if (.not. allocated(F2N)) allocate(F2N(nx_block,ny_block,max_blocks))
+   if (.not. allocated(F2E)) allocate(F2E(nx_block,ny_block,max_blocks))
+   if (.not. allocated(F2N)) allocate(F2N(nx_block,ny_block,max_blocks))
    F2E = 0.0d0
    F2N = 0.0d0
 
@@ -2768,6 +2769,8 @@ subroutine build_F2_form_factors_cgrid(F2E, F2N, coast_file, coast_var, F2_value
       end if
    end if
 
+   cdp_ff_built = .true._log_kind
+
    ! ----- cleanup -----
    if (use_coast) then
       if (allocated(coastT)) deallocate(coastT)
-- 
2.43.7

