From 847ef477145d399b3c2c008847f230439717a0c5 Mon Sep 17 00:00:00 2001
From: dpath2o <dpath2o@mac.com>
Date: Wed, 22 Oct 2025 03:42:41 +1100
Subject: [PATCH 03/34] adding new subroutine strain_rates_U_free_slip

---
 cicecore/cicedyn/dynamics/ice_dyn_evp.F90    |  17 ++-
 cicecore/cicedyn/dynamics/ice_dyn_shared.F90 | 133 ++++++++++++++++++-
 2 files changed, 147 insertions(+), 3 deletions(-)

diff --git a/cicecore/cicedyn/dynamics/ice_dyn_evp.F90 b/cicecore/cicedyn/dynamics/ice_dyn_evp.F90
index 39d5a8e..5fa1fd4 100644
--- a/cicecore/cicedyn/dynamics/ice_dyn_evp.F90
+++ b/cicecore/cicedyn/dynamics/ice_dyn_evp.F90
@@ -291,7 +291,7 @@ subroutine evp (dt)
           DminTarea, visc_method, deformations, deformationsC_T, deformationsCD_T, &
           strain_rates_U, dxhy, dyhx, cxp, cyp, cxm, cym, &
           iceTmask, iceUmask, iceEmask, iceNmask, &
-          dyn_haloUpdate, fld2, fld3, fld4
+          dyn_haloUpdate, fld2, fld3, fld4, strain_rates_U_free_slip
       use ice_dyn_evp1d, only: dyn_evp1d_run
 
       real (kind=dbl_kind), intent(in) :: &
@@ -940,7 +940,7 @@ subroutine evp (dt)
             ! strain rates at U point
             ! NOTE these are actually strain rates * area  (m^2/s)
             !-----------------------------------------------------------------
-               call strain_rates_U (nx_block          , ny_block           , &
+               call strain_rates_U_free_slip (nx_block          , ny_block           , &
                                     icellU      (iblk),                      &
                                     indxUi    (:,iblk), indxUj     (:,iblk), &
                                     uvelE   (:,:,iblk), vvelE    (:,:,iblk), &
@@ -953,6 +953,19 @@ subroutine evp (dt)
                                     epm     (:,:,iblk), npm      (:,:,iblk), &
                                     divergU (:,:,iblk), tensionU (:,:,iblk), &
                                     shearU  (:,:,iblk), deltaU   (:,:,iblk)  )
+               ! call strain_rates_U (nx_block          , ny_block           , &
+               !                      icellU      (iblk),                      &
+               !                      indxUi    (:,iblk), indxUj     (:,iblk), &
+               !                      uvelE   (:,:,iblk), vvelE    (:,:,iblk), &
+               !                      uvelN   (:,:,iblk), vvelN    (:,:,iblk), &
+               !                      uvel    (:,:,iblk), vvel     (:,:,iblk), &
+               !                      dxE     (:,:,iblk), dyN      (:,:,iblk), &
+               !                      dxU     (:,:,iblk), dyU      (:,:,iblk), &
+               !                      ratiodxN(:,:,iblk), ratiodxNr(:,:,iblk), &
+               !                      ratiodyE(:,:,iblk), ratiodyEr(:,:,iblk), &
+               !                      epm     (:,:,iblk), npm      (:,:,iblk), &
+               !                      divergU (:,:,iblk), tensionU (:,:,iblk), &
+               !                      shearU  (:,:,iblk), deltaU   (:,:,iblk)  )
 
             enddo  ! iblk
             !$OMP END PARALLEL DO
diff --git a/cicecore/cicedyn/dynamics/ice_dyn_shared.F90 b/cicecore/cicedyn/dynamics/ice_dyn_shared.F90
index 40f4987..9ff4d9c 100644
--- a/cicecore/cicedyn/dynamics/ice_dyn_shared.F90
+++ b/cicecore/cicedyn/dynamics/ice_dyn_shared.F90
@@ -27,7 +27,7 @@ module ice_dyn_shared
                 principal_stress, init_dyn_shared, dyn_prep1, dyn_prep2, dyn_finish, &
                 seabed_stress_factor_LKD, seabed_stress_factor_prob, &
                 deformations, deformationsC_T, deformationsCD_T, &
-                strain_rates, strain_rates_T, strain_rates_U, &
+                strain_rates, strain_rates_T, strain_rates_U, strain_rates_U_free_slip, &
                 visc_replpress, &
                 dyn_haloUpdate, &
                 stack_fields, unstack_fields
@@ -2390,6 +2390,137 @@ subroutine strain_rates_U (nx_block,   ny_block,  &
 
       end subroutine strain_rates_U
 
+!=======================================================================
+! Compute strain rates at the U point — FREE-SLIP (Neumann)
+! Inputs are identical to strain_rates_U_no_slip
+! Free-slip = zero normal flow; zero normal derivative of tangential
+!
+! IMPORTANT:
+!  - Do NOT clamp ratios: use rp = -ratio (even reflection)
+!  - No changes to calling signature versus no-slip version
+!  - Prints shearU at coastal U points (last subcycle only)
+!=======================================================================
+   subroutine strain_rates_U_free_slip(nx_block, ny_block,  &
+                                       icellU,              &
+                                       indxUi,   indxUj,    &
+                                       uvelE,    vvelE,     &
+                                       uvelN,    vvelN,     &
+                                       uvelU,    vvelU,     &
+                                       dxE,      dyN,       &
+                                       dxU,      dyU,       &
+                                       ratiodxN, ratiodxNr, &
+                                       ratiodyE, ratiodyEr, &
+                                       epm,      npm,       &
+                                       divergU,  tensionU,  &
+                                       shearU,   DeltaU,    &
+                                       ksub,     ndte)
+
+      use ice_kinds_mod, only: int_kind, dbl_kind
+      implicit none
+
+      !----------------------------
+      ! Arguments (identical to no-slip)
+      !----------------------------
+      integer (kind=int_kind), intent(in) :: nx_block, ny_block, icellU
+      integer (kind=int_kind), intent(in) :: ksub, ndte
+      integer (kind=int_kind), dimension (nx_block*ny_block), intent(in) :: &
+         indxUi, indxUj
+
+      real (kind=dbl_kind), dimension (nx_block,ny_block), intent(in) :: &
+         uvelE, vvelE, uvelN, vvelN, uvelU, vvelU, &
+         dxE, dyN, dxU, dyU, &
+         ratiodxN, ratiodxNr, ratiodyE, ratiodyEr, &
+         epm, npm
+
+      real (kind=dbl_kind), dimension (nx_block,ny_block), intent(out) :: &
+         divergU, tensionU, shearU, DeltaU
+
+      !----------------------------
+      ! Locals
+      !----------------------------
+      integer (kind=int_kind) :: ij, i, j
+      real (kind=dbl_kind) :: uNip1j, uNij, vEijp1, vEij, uEijp1, uEij, vNip1j, vNij
+      real (kind=dbl_kind) :: rpdxN, rpdxNr, rpdyE, rpdyEr
+
+      ! module constants assumed available in host: c0, e_factor, nu_diag
+      ! if not, add USE for their modules.
+
+      divergU (:,:) = c0
+      tensionU(:,:) = c0
+      shearU  (:,:) = c0
+      DeltaU  (:,:) = c0
+
+      !----------------------------
+      ! Build strains at U (free-slip)
+      !----------------------------
+      do ij = 1, icellU
+         i = indxUi(ij)
+         j = indxUj(ij)
+
+         ! Even reflection for free-slip: rp = - ratio (NO clamping to >= 0)
+         rpdxN  = -ratiodxN (i,j)
+         rpdxNr = -ratiodxNr(i,j)
+         rpdyE  = -ratiodyE (i,j)
+         rpdyEr = -ratiodyEr(i,j)
+
+         ! ---- e11 + e22 terms (divergence / tension use these du/dx, dv/dy parts) ----
+         ! u on N faces across x-direction (handles coast via mask+ratio)
+         uNip1j = uvelN(i+1,j) * npm(i+1,j) + (npm(i,j)   - npm(i+1,j)) * npm(i,j)   * rpdxN  * uvelN(i  ,j)
+         uNij   = uvelN(i  ,j) * npm(i  ,j) + (npm(i+1,j) - npm(i  ,j)) * npm(i+1,j) * rpdxNr * uvelN(i+1,j)
+
+         ! v on E faces across y-direction
+         vEijp1 = vvelE(i,j+1) * epm(i,  j+1) + (epm(i,  j) - epm(i,  j+1)) * epm(i,  j) * rpdyE  * vvelE(i,  j)
+         vEij   = vvelE(i,  j) * epm(i,  j  ) + (epm(i,  j+1) - epm(i,  j )) * epm(i,  j+1) * rpdyEr * vvelE(i,  j+1)
+
+         ! divergence  = e11 + e22  (area-weighted form)
+         divergU(i,j) = dyU(i,j)   * (uNip1j - uNij)     &
+                     + uvelU(i,j) * (dyN(i+1,j) - dyN(i,j)) &
+                     + dxU(i,j)   * (vEijp1 - vEij)     &
+                     + vvelU(i,j) * (dxE(i,j+1) - dxE(i,j))
+
+         ! tension     = e11 - e22
+         tensionU(i,j) = dyU(i,j)   * (uNip1j - uNij)     &
+                     - uvelU(i,j) * (dyN(i+1,j) - dyN(i,j)) &
+                     - dxU(i,j)   * (vEijp1 - vEij)     &
+                     + vvelU(i,j) * (dxE(i,j+1) - dxE(i,j))
+
+         ! ---- 2*e12 terms (shear uses du/dy on E and dv/dx on N with same BC logic) ----
+         uEijp1 = uvelE(i,  j+1) * epm(i,  j+1) + (epm(i,  j) - epm(i,  j+1)) * epm(i,  j) * rpdyE  * uvelE(i,  j)
+         uEij   = uvelE(i,  j  ) * epm(i,  j  ) + (epm(i,  j+1) - epm(i,  j )) * epm(i,  j+1) * rpdyEr * uvelE(i,  j+1)
+
+         vNip1j = vvelN(i+1,j  ) * npm(i+1,j  ) + (npm(i,  j) - npm(i+1,j)) * npm(i,  j) * rpdxN  * vvelN(i,  j)
+         vNij   = vvelN(i,  j  ) * npm(i,  j  ) + (npm(i+1,j) - npm(i,  j )) * npm(i+1,j) * rpdxNr * vvelN(i+1,j)
+
+         shearU(i,j) =  dxU(i,j) * (uEijp1 - uEij)               &
+                     - uvelU(i,j) * (dxE(i,  j+1) - dxE(i,  j))  &
+                     + dyU(i,j) * (vNip1j - vNij)                &
+                     - vvelU(i,j) * (dyN(i+1,j  ) - dyN(i,  j))
+
+         ! denominator helper
+         DeltaU(i,j) = sqrt( divergU(i,j)**2 + e_factor * ( tensionU(i,j)**2 + shearU(i,j)**2 ) )
+
+      end do
+
+      !----------------------------
+      ! Debug print: shearU at coastal U points (last subcycle only)
+      ! A U point is “coastal” if any of its 4 surrounding faces is masked
+      ! (uses epm/npm only; no tmask required)
+      !----------------------------
+      if (ksub == ndte) then
+         do j = 2, ny_block-1
+            do i = 2, nx_block-1
+               if (epm(i,  j  ) == c0 .or. epm(i,  j-1) == c0 .or. &
+                  npm(i,  j  ) == c0 .or. npm(i-1,  j) == c0) then
+                  write(nu_diag,'(a,2i6,1x,es16.8)') 'free-slip shearU at coastal U (i,j,val)=', &
+                        i, j, shearU(i,j)
+               end if
+            end do
+         end do
+         call flush(nu_diag)
+      end if
+
+end subroutine strain_rates_U_free_slip
+
 !=======================================================================
 ! Computes viscosities and replacement pressure for stress
 ! calculations. Note that tensile strength is included here.
-- 
2.43.7

